=== フラッシュメッセージ

ユーザの新規登録が成功したら、新規登録したユーザのユーザ表示画面へ遷移します。
この動作自体でユーザの新規登録が成功したことが判りますが、出来れば新規登録操作が成功したことを明示的に示したいです。

そこで、画面遷移後、画面上にフラッシュメッセージを表示することにしましょう。

ユーザの新規登録成功時、リダイレクト前に表示するメッセージをRailsが用意している**flush**変数へ格納します。

flush変数とは少し特殊な変数で、リダイレクト先の画面へ値を渡すのに使用できます。
また、画面表示後、flush変数の中身はクリアされます。

（ただし、renderメソッドによる再表示など、移動を伴わない画面表示時にクリアされません）

[source, rb]
.app/controllers/users_controller.rb
----
class UsersController < ApplicationController

  def create
    @user = User.new(user_params)
    if @user.save

      flash[:success] = "Welcome to the World!" # <1>

      redirect_to @user
    else
      render 'new'
    end
  end
end
----

<1> フラッシュメッセージをflush変数へ格納

次にViewにフラッシュメッセージを追加します。

このメッセージ表示の機能は他のケースでも使用したいので、共通のヘッダ部にメッセージを表示するようにします。

[source,html]
.views/layouts/application.html.erb
----
<!DOCTYPE html>
<html>
  <head>
    <title><%= yield(:title) %> | Ruby on Rails Example</title>
    <%= csrf_meta_tags %>

    <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>
  </head>
  <body>
    <header class="navbar navbar-fixed-top navbar-inverse">
      <div class="container">
        <%= link_to "Ruby on Rails Example", '#', id: "logo" %>
        <nav>
          <ul class="nav navbar-nav navbar-right">
            <li><%= link_to "Home",   '#' %></li>
            <li><%= link_to "Log in", '#' %></li>
          </ul>
        </nav>
      </div>
    </header>
    <div class="container">

      <% flash.each do |message_type, message| %>  <!--1-->
        <div class="alert alert-<%= message_type %>"><%= message %></div>
      <% end %>

      <%= yield %>
    </div>
  </body>
</html>
----

<1> flush変数に格納したメッセージの表示を追加

試しにユーザ登録をしてみましょう。

.ユーザ作成成功
image::images/sign_up_success.png[ユーザ作成成功]

ちゃんとメッセージが表示されました。

テストも実装しましょう。
既にユーザ新規登録画面からユーザを新規登録するテストは実装しているので、そこにメッセージ表示についての確認を追加しましょう。

[source, rb]
----
require 'test_helper'

class UsersSignupTest < ActionDispatch::IntegrationTest

  test 'valid signup information' do
    get new_user_path

    assert_difference 'User.count', 1 do
      post users_path, params: { user: { name:  'Example User',
                                         email: 'user@example.com',
                                         password:              'password',
                                         password_confirmation: 'password' } }
    end

    follow_redirect!
    assert_template 'users/show'

    # <1>
    assert_not flash.empty?

    # <2>
    assert_select 'div.alert-success'
  end
end
----

<1> flush変数にメッセージが格納されている
<2> 登録成功のメッセージが表示される
